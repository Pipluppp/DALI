<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="selector(stores, selectedStoreId)">
    <h4>Select a Pickup Location</h4>
    <div id="pickup-store-map"></div>
    <input type="search" id="store-search-input" name="query" placeholder="Search or select a pin from the map..."
           hx-get="/stores/search-for-checkout"
           hx-trigger="keyup changed delay:300ms, search"
           hx-target="#store-list-results"
           class="main-search-input" style="margin-bottom: 15px; border-radius: 30px;">
    <div id="store-list-results">
        <div th:replace="~{fragments/checkout-store-list :: store-list-fragment(stores=${stores}, selectedStoreId=${selectedStoreId})}"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let pickupMap;
            const markerMap = new Map();
            const mapContainer = document.getElementById('pickup-store-map');
            const storeListResults = document.getElementById('store-list-results');
            const storeSelectorSection = document.getElementById('store-pickup-selector');
            let storeIdToSelectAfterLoad = null;

            function initializePickupMap() {
                if (!mapContainer || pickupMap) return;

                pickupMap = L.map(mapContainer).setView([14.5995, 120.9842], 11);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '© OpenStreetMap contributors © CARTO',
                }).addTo(pickupMap);

                const pinkIcon = L.divIcon({
                    html: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#b21984" width="32px" height="32px"><path d="M12 0C7.8 0 4 3.8 4 8.5c0 5.1 8 15.5 8 15.5s8-10.4 8-15.5C20 3.8 16.2 0 12 0zm0 12a3 3 0 110-6 3 3 0 010 6z"/></svg>`,
                    className: '', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
                });

                fetch('/api/stores')
                    .then(response => response.json())
                    .then(stores => {
                        stores.forEach(store => {
                            if (store.latitude && store.longitude) {
                                const marker = L.marker([store.latitude, store.longitude], { icon: pinkIcon }).addTo(pickupMap);
                                marker.bindPopup(`<b>${store.name}</b>`);
                                markerMap.set(store.id, marker);

                                marker.on('click', () => {
                                    const searchInput = document.getElementById('store-search-input');
                                    storeIdToSelectAfterLoad = store.id;
                                    if (searchInput) searchInput.value = store.name;
                                    htmx.trigger(searchInput, 'search');
                                });
                            }
                        });
                    });
                setTimeout(() => pickupMap.invalidateSize(), 10);
            }

            const observer = new MutationObserver((mutations) => {
                for (let mutation of mutations) {
                    if (mutation.attributeName === 'style' && storeSelectorSection.style.display === 'block') {
                        initializePickupMap();
                    }
                }
            });

            if (storeSelectorSection) {
                observer.observe(storeSelectorSection, { attributes: true });
            }

            if (storeListResults) {
                storeListResults.addEventListener('click', (event) => {
                    const storeItem = event.target.closest('.delivery-option');
                    if (!storeItem || !pickupMap) return;

                    const lat = parseFloat(storeItem.dataset.lat);
                    const lng = parseFloat(storeItem.dataset.lng);
                    const storeId = parseInt(storeItem.dataset.storeId, 10);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        pickupMap.flyTo([lat, lng], 15);
                        if (markerMap.has(storeId)) {
                            setTimeout(() => markerMap.get(storeId).openPopup(), 400);
                        }
                    }
                });

                storeListResults.addEventListener('htmx:afterSettle', function() {
                    if (storeIdToSelectAfterLoad) {
                        const radioToSelect = document.getElementById('store-' + storeIdToSelectAfterLoad);
                        if (radioToSelect) {
                            radioToSelect.checked = true;
                        }
                        storeIdToSelectAfterLoad = null;
                    }
                });
            }
        });
    </script>
</div>
</body>
</html>